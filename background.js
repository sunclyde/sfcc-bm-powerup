var pageMapping = [];
pageMapping["​Libraries"] = "ViewContentSharedLibrary-List"; //​Libraries
pageMapping["​Library Folders"] = "ViewLibrary_52-Start"; //​Library Folders
pageMapping["​Content Assets"] = "ViewLibraryContentList_52-Start"; //​Content Assets
pageMapping["​Import & Export"] = "ViewLibraryImpex_52-Status"; //​Import & Export
pageMapping["​Page Designer"] = "ViewLdsBusinessManagerScreen-PageDesigner"; //​Page Designer
pageMapping["​Customers"] = "ViewCustomers-List"; //​Customers
pageMapping["​Customer Groups"] = "ViewApplication-BM?screen=CustomerGroup"; //​Customer Groups
pageMapping["​Snapshots"] = "ViewCustomerSnapshots-Start"; //​Snapshots
pageMapping["​Batch Processes"] = "ViewCustomerProcessList_52-ListAll"; //​Batch Processes
pageMapping["​Import & Export"] = "ViewCustomerImpex-Status"; //​Import & Export
pageMapping["​Custom Object Editor"] = "ViewCustomObjectList_52-Start"; //​Custom Object Editor
pageMapping["​Batch Processes"] = "ViewCustomObjectProcessList_52-ListAll"; //​Batch Processes
pageMapping["​Import & Export"] = "ViewCustomObjectImpex_52-Status"; //​Import & Export
pageMapping["​URL Rules"] = "ViewStorefrontURLRules-Start"; //​URL Rules
pageMapping["​URL Redirects"] = "ViewUrlRedirectList_52-Start"; //​URL Redirects
pageMapping["​Static Mappings"] = "ViewStaticMappings_52-Start"; //​Static Mappings
pageMapping["​Dynamic Mappings"] = "ViewDynamicMappings_52-Start"; //​Dynamic Mappings
pageMapping["​Robots"] = "ViewSiteRobotsDefinition-Start"; //​Robots
pageMapping["​Aliases"] = "ViewAliases_52-Start"; //​Aliases
pageMapping["​Customer CDN Settings"] = "ViewApplication-BM?screen=customerCdns"; //​Customer CDN Settings
pageMapping["​Sitemaps"] = "ViewSitemap-Start"; //​Sitemaps
pageMapping["​URL Request Analyzer"] = "ViewStorefrontURLRequestAnalyzer-Start"; //​URL Request Analyzer
pageMapping["​Page Meta Tag Rules"] = "ViewLdsBusinessManagerScreen-Start"; //​Page Meta Tag Rules
pageMapping["Products"] = "ViewProductList_52-List"; //​Products
pageMapping["​Product Sets"] = "ViewProductList_52-List"; //​Product Sets
pageMapping["​Catalogs"] = "ViewChannelCatalogList_52-Start"; //​Catalogs
pageMapping["​Product Options"] = "ViewSharedProductOptions_52-ListCatalogs"; //​Product Options
pageMapping["​Variation Attributes"] = "ViewSharedProductVariations_52-ListCatalogs"; //​Variation Attributes
pageMapping["​Recommendations"] = "ViewRecommendationCatalogs_52-ListAll"; //​Recommendations
pageMapping["​Price Books"] = "ViewPriceBookList_52-ListAll"; //​Price Books
pageMapping["​Inventory"] = "ViewInventoryLists_52-ListAll"; //​Inventory
pageMapping["​Catalog Feeds"] = "ViewCatalogFeeds_52-Start"; //​Catalog Feeds
pageMapping["​Batch Processes"] = "ViewProductCatalogProcessList_52-ListAll"; //​Batch Processes
pageMapping["​Import & Export"] = "ViewCatalogImpex_52-Status"; //​Import & Export
pageMapping["​Orders"] = "ViewOrderList_52-Dispatch?enter=enter"; //​Orders
pageMapping["​Taxation"] = "ViewTaxPreferences_52-Start"; //​Taxation
pageMapping["​Payment Processors"] = "ViewPaymentMethodList_52-ListAll"; //​Payment Processors
pageMapping["​Payment Methods"] = "PaymentMethod-Start"; //​Payment Methods
pageMapping["​Shipping Methods"] = "ShippingMethodList-ListAll"; //​Shipping Methods
pageMapping["​Import & Export"] = "ViewOrderImpex_52-Status"; //​Import & Export
pageMapping["​Search Indexes"] = "ViewSearchIndexList_52-Start"; //​Search Indexes
pageMapping["​Search Index Rebuild Schedule"] = "ViewSearchIndexSchedule_52-Start"; //​Search Index Rebuild Schedule
pageMapping["​Search Index Query Testing"] = "ViewProductIndexExecutionPlan_52-Start"; //​Search Index Query Testing
pageMapping["​Search Dictionaries"] = "ViewLdsBusinessManagerScreen-Start"; //​Search Dictionaries
pageMapping["​Searchable Attributes"] = "SearchableAttributes-Start"; //​Searchable Attributes
pageMapping["​Search Driven Redirects"] = "ViewSearchRedirectList_52-Start"; //​Search Driven Redirects
pageMapping["​Stop Word Dictionary"] = "ViewLdsBusinessManagerScreen-Start"; //​Stop Word Dictionary
pageMapping["​Category Name Exclusions"] = "ViewLdsBusinessManagerScreen-Start"; //​Category Name Exclusions
pageMapping["​Synonym Dictionary"] = "ViewLdsBusinessManagerScreen-Start"; //​Synonym Dictionary
pageMapping["​Hypernym Dictionary"] = "ViewLdsBusinessManagerScreen-Start"; //​Hypernym Dictionary
pageMapping["​Compound Word Dictionary"] = "ViewLdsBusinessManagerScreen-Start"; //​Compound Word Dictionary
pageMapping["​Common Phrase Dictionary"] = "ViewLdsBusinessManagerScreen-Start"; //​Common Phrase Dictionary
pageMapping["​Search Suggestions"] = "ViewLdsBusinessManagerScreen-Start"; //​Search Suggestions
pageMapping["​Stemming Exceptions"] = "ViewLdsBusinessManagerScreen-Start"; //​Stemming Exceptions
pageMapping["​Keyword Groups"] = "ViewLdsBusinessManagerScreen-Start"; //​Keyword Groups
pageMapping["​Sorting Rules"] = "SortingRules-Start"; //​Sorting Rules
pageMapping["​Storefront Sorting Options"] = "ViewStorefrontSortingOptions_52-Start"; //​Storefront Sorting Options
pageMapping["​Search Preferences"] = "ViewSearchPreferences_52-Start"; //​Search Preferences
pageMapping["​Import & Export"] = "ViewSearchImpex-Status"; //​Import & Export
pageMapping["​Campaigns"] = "ViewApplication-BM?screen=campaigns"; //​Campaigns
pageMapping["​A/B Tests"] = "ABTest-Start"; //​A/B Tests
pageMapping["​Promotions"] = "ViewApplication-BM?screen=Promotion"; //​Promotions
pageMapping["​Content Slots"] = "SlotList-ListAll"; //​Content Slots
pageMapping["​Coupons"] = "ViewApplication-BM?screen=coupons"; //​Coupons
pageMapping["​Source Code Groups"] = "ViewApplication-BM?screen=SourceCode"; //​Source Code Groups
pageMapping["​Active Data"] = "ViewActiveDataMenu_52-Start"; //​Active Data
pageMapping["​Stores"] = "ViewApplication-BM?screen=Store"; //​Stores
pageMapping["​Gift Certificates"] = "ViewApplication-BM?screen=GiftCertificate"; //​Gift Certificates
pageMapping["​Import & Export"] = "ViewOnlineMarketingImpex_52-Status"; //​Import & Export
pageMapping["​Conversion Reports"] = "ViewAnalytics_52-Refresh"; //​Conversion Reports
pageMapping["​Purchase Reports"] = "ViewAnalytics_52-Refresh"; //​Purchase Reports
pageMapping["​Catalog Reports"] = "ViewAnalytics_52-Refresh"; //​Catalog Reports
pageMapping["​Search and Navigation Reports"] = "ViewAnalytics_52-Refresh"; //​Search and Navigation Reports
pageMapping["​Customer Reports"] = "ViewAnalytics_52-Refresh"; //​Customer Reports
pageMapping["​Traffic Reports"] = "ViewAnalytics_52-Refresh"; //​Traffic Reports
pageMapping["​A/B Testing Reports"] = "ViewAnalytics_52-Refresh"; //​A/B Testing Reports
pageMapping["​Legacy Reports"] = "ViewHistoricalReports-View"; //​Legacy Reports
pageMapping["​Locking"] = "ViewProductPreferences_52-Start"; //​Locking
pageMapping["​Baskets"] = "ViewBasketPreferences_52-Start"; //​Baskets
pageMapping["​A/B Tests"] = "ViewABTestPreferences-Start"; //​A/B Tests
pageMapping["​Locales"] = "ViewRegionalSettings_52-Start"; //​Locales
pageMapping["​Currencies"] = "SiteCurrencies-Start"; //​Currencies
pageMapping["​Source Codes"] = "ViewSourceCodePreferences_52-Edit"; //​Source Codes
pageMapping["​Gift Certificates"] = "ViewGiftCertificatePreferences_52-Display"; //​Gift Certificates
pageMapping["​Search Preferences"] = "ViewSearchPreferences_52-Start"; //​Search Preferences
pageMapping["​Sequence Numbers"] = "ViewSeriesNumbers_52-Start"; //​Sequence Numbers
pageMapping["​Order Preferences"] = "ViewOrderPreferences_52-Start"; //​Order
pageMapping["​Coupons"] = "ViewCouponPreferences_52-Start"; //​Coupons
pageMapping["​Promotion Preference"] = "ViewPromotionPreferences_52-Start"; //​Promotions
pageMapping["​Deprecated Storefront Toolkit"] = "ViewStorefrontToolkitPreferences_52-Start"; //​Deprecated Storefront Toolkit
pageMapping["​Storefront URLs"] = "ViewStorefrontURLPreferences-Start"; //​Storefront URLs
pageMapping["​Custom Preferences"] = "ViewApplication-BM?screen=preference%23site_preference_groups"; //​Custom Preferences
pageMapping["​Pinterest Commerce"] = "ViewPinterestCommerceConfiguration-Start"; //​Pinterest Commerce
pageMapping["​Privacy"] = "ViewPrivacyPreferences-Edit"; //​Privacy
pageMapping["​Customer Service Center Preferences"] = "ViewCSCPreferences-Start"; //​Customer Service Center Preferences
pageMapping["​Apple Pay"] = "ViewApplePayConfiguration-Start"; //​Apple Pay
pageMapping["​Data Replication"] = "ViewReplicationProcessList-List"; //​Data Replication
pageMapping["​Code Replication"] = "ViewCodeReplicationProcessList-List"; //​Code Replication
pageMapping["​Organization Profile"] = "ViewOrganization-Edit"; //​Organization Profile
pageMapping["​Users"] = "ViewUserList-List"; //​Users
pageMapping["​Roles & Permissions"] = "ViewAccessRoles-Start"; //​Roles & Permissions
pageMapping["​Permission Audit"] = "ViewPermissionsUsers-Start"; //​Permission Audit
pageMapping["​WebDAV Client Permissions"] = "ViewWebdavClientPermissions-Start"; //​WebDAV Client Permissions
pageMapping["Manage Sites"] = "ViewChannelList-ListAll"; //Manage Sites
pageMapping["Customer Lists"] = "ViewCustomerLists-ListAll"; //Customer Lists
pageMapping["Content Libraries"] = "ViewAdminSharedLibrary-List"; //Content Libraries
pageMapping["Batch Processes"] = "ViewCustomerListProcessList_52-ListAll"; //Batch Processes
pageMapping["Embedded CDN Settings"] = "ViewApplication-BM?screen=embedded-cdn"; //Embedded CDN Settings
pageMapping["Total File Demander"] = "TFD-Start"; //Total File Demander
pageMapping["Browse Remote - Http"] = "BrowseRemote-Http"; //Browse Remote - Http
pageMapping["Terminal"] = "Terminal-Start"; //Terminal
pageMapping["Mapping Manager"] = "MappingManager-Show"; //Mapping Manager
pageMapping["BM Session Keep Alive"] = "BMSession-KeepAlive"; //BM Session Keep Alive
pageMapping["Development Setup"] = "ViewStudioSetup-Start"; //Development Setup
pageMapping["Code Deployment"] = "ViewCodeDeployment-Start"; //Code Deployment
pageMapping["System Object Types"] = "ViewSystemObjectTypeList-Start"; //System Object Types
pageMapping["Custom Object Types"] = "ViewCustomObjectTypeList-Start"; //Custom Object Types
pageMapping["Custom Error Pages"] = "ViewCustomErrorpages-Status"; //Custom Error Pages
pageMapping["Custom Maintenance Pages"] = "ViewCustomMaintPages-Status"; //Custom Maintenance Pages
pageMapping["Deprecated API Usage"] = "ViewDeprecatedApiUsage-Start"; //Deprecated API Usage
pageMapping["Import & Export"] = "ViewCustomizationImpex-Start"; //Import & Export
pageMapping["Site Import & Export"] = "ViewSiteImpex-Status"; //Site Import & Export
pageMapping["Open Commerce API Settings"] = "ViewWapiSettings-Start"; //Open Commerce API Settings
pageMapping["Customer Service Center Settings"] = "ViewCSCSettings-View"; //Customer Service Center Settings
pageMapping["Locales"] = "ViewLocales-Show"; //Locales
pageMapping["Instance Time Zone"] = "ViewInstanceTimeZone-Show"; //Instance Time Zone
pageMapping["Change History"] = "ViewAuditPreferences-View"; //Change History
pageMapping["OAuth2 Providers"] = "ViewOAuth2ProviderList-ListAll"; //OAuth2 Providers
pageMapping["Security"] = "ViewSecurityPreferencesUserAuth-View"; //Security
pageMapping["Store Locator Data"] = "ViewGeolocations-Start"; //Store Locator Data
pageMapping["Feature Switches"] = "ViewFeatureSwitchPreferences-Show"; //Feature Switches
pageMapping["Order Search"] = "ViewOrderSearchPreferences-Start"; //Order Search
pageMapping["Sequence Numbers"] = "ViewSeriesNumbers-Start"; //Sequence Numbers
pageMapping["Products Preferences"] = "ViewProductPreferences-Start"; //Products
pageMapping["Retention Settings"] = "ViewProductListPreferences-Start"; //Retention Settings
pageMapping["Import & Export"] = "ViewImpexSettings-Start"; //Import & Export
pageMapping["Global Timeouts"] = "ViewServiceCommonCfg-DisplayAll"; //Global Timeouts
pageMapping["Global Custom Preferences"] = "GlobalCustomPreferences-View"; //Custom Preferences
pageMapping["Einstein Search Dictionaries Opt-In"] = "DataPrivacyAgreement-View"; //Einstein Search Dictionaries Opt-In
pageMapping["Analytics"] = "ViewBMAnalyticsConfiguration_52-IpAddressExclusions"; //Analytics
pageMapping["Cross Cloud"] = "ViewCustomer360-Start"; //Cross Cloud
pageMapping["Jobs"] = "ViewApplication-BM?screen=job"; //Jobs
pageMapping["Job History"] = "ViewApplication-BM?screen=job%23history"; //Job History
pageMapping["Jobs (Deprecated)"] = "SMCScheduler-DisplayAll"; //Jobs (Deprecated)
pageMapping["Job History (Deprecated)"] = "ViewJobMonitor-DisplayAll"; //Job History (Deprecated)
pageMapping["Job Statistics"] = "ViewJobStatistics-Start"; //Job Statistics
pageMapping["Import & Export"] = "ViewOperationsImpex-Start"; //Import & Export
pageMapping["GMV Reports"] = "ViewOrderJournalImpex-Start"; //GMV Reports
pageMapping["Custom Log Settings"] = "ViewApplication-BM?screen=customLogSettings"; //Custom Log Settings
pageMapping["Code Profiler"] = "ViewLdsBusinessManagerScreen-Start"; //Code Profiler
pageMapping["Pipeline Profiler"] = "ViewPipelineProfiler-Start"; //Pipeline Profiler
pageMapping["Custom Caches"] = "ViewCustomCaches-Start"; //Custom Caches
pageMapping["Quota Status"] = "ViewQuotaStatus-Start"; //Quota Status
pageMapping["Change History"] = "ViewAuditHistory-Start"; //Change History
pageMapping["Encryption Keys"] = "ViewEncryptionKeyList-ListAll"; //Encryption Keys
pageMapping["Private Keys and Certificates"] = "ViewApplication-BM?screen=PrivateKey"; //Private Keys and Certificates
pageMapping["Services"] = "Service-DisplayAll"; //Services
pageMapping["Service Status"] = "ServiceAnalytics-Overview"; //Service Status
pageMapping["IP Address Geolocation Data"] = "ViewIPGeolocations-Start"; //IP Address Geolocation Data
pageMapping["Einstein Status Dashboard"] = "ViewLdsBusinessManagerScreen-Start"; //Einstein Status Dashboard
pageMapping["Workflow Schedules"] = "WorkflowUI-Overview"; //Workflow Schedules
pageMapping["Workflow Plan"] = "WorkflowUI-WorkflowPlan"; //Workflow Plan

var bmURL = "-loreal.demandware.net/on/demandware.store/Sites-Site/default/";

//var selectSite = "https://production-apac-loreal.demandware.net/on/demandware.store/Sites-Site/default/ViewApplication-SelectSite?SelectedSiteID=bcTnYiaag06YQaaadrl7YImrh5";
//var selectSite = "https://production-apac-loreal.demandware.net/on/demandware.store/Sites-Site/default/ViewProductList_52-List?";

chrome.omnibox.onInputEntered.addListener((text, disposition) => {
    //console.log("[" + new Date() + "] text.startsWith(https://): " + text.startsWith("https://"));
    if (text.startsWith("https://")) {
        chrome.tabs.create({ url: text });
    }

    /*
    //console.log("[" + new Date() + "] omnibox event: onInputEntered, user input: " + text + ", disposition: " + disposition);
    var arr = [];
    var instance = null;
    var page = null;
    
    if (text.indexOf('-') < 0) {
        console.error('wrong cmd: invalid format');
        return;
    }

    arr = text.split('-');

    switch (arr[0]) {
    case "ap":
        instance = "production-apac";
        break;
    case "as":
        instance = "staging-apac";
        break;
    case "ad":
        instance = "development-apac";
        break;
    case "jp":
        instance = "production-jp";
        break;
    case "js":
        instance = "staging-jp";
        break;
    case "jd":
        instance = "development-jp";
        break;
    case "cp":
        instance = "production-cn";
        break;
    case "cs":
        instance = "staging-cn";
        break;
    case "cd":
        instance = "development-cn";
        break;
    case "default":
        instance = null;
        break;
    }

    if (instance == null) {
        console.error('wrong cmd: invalid instance');
        return;
    }

    var module = null;
    if (!(arr[1] in pageMapping)) {
        console.error('wrong cmd: invalid module');
        return;
    }
    module = pageMapping[arr[1]];

    var newURL = "https://" + instance + bmURL + "/" + module;
    chrome.tabs.create({ url: "https://production-apac-loreal.demandware.net/on/demandware.store/Sites-Site/default/ViewApplication-SelectSite?SelectedSiteID=bcTnYiaag06YQaaadrl7YImrh5" });
    chrome.tabs.create({ url: newURL });
    */
});

chrome.omnibox.onInputChanged.addListener((text, suggest) => {
    //console.log("[" + new Date() + "] omnibox event: onInputChanged, user input: " + text);

    var suggestion = getSuggestion(text);
    if (suggestion != null) {
        console.log("[" + new Date() + "] omnibox event: suggestion(" + suggestion.length + "): " + JSON.stringify(suggestion));
        suggest(suggestion);
    } else {
        /*
        suggest([{
            "content": text + " foo",
            "description": "是否要查看“" + text + " foo” 有关的内容？"
        }, {
            "content": text + " bar",
            "description": "是否要查看“" + text + " bar” 有关的内容？"
        }
        ])
        */
    }
});

function getSuggestion(text) {
    var suggestion = null;

    if (text.length < 2) {
        //console.log("[" + new Date() + "] omnibox event: input text length < 2");
        return null;
    }

    if (text.length == 2) {
        // console.log("[" + new Date() + "] omnibox event: input text length = 2");
        var realm = getRealm(text);
        if (realm == null) {
            return null;
        }
        var instance = getInstance(text);
        if (instance == null) {
            return null;
        }
        var url = "https://" + instance + "-" + realm + "-loreal.demandware.net/on/demandware.store/Sites-Site/default/ViewLogin-StartAM";
        suggestion = [{
            "content": url,
            "description": "Go to " + instance.toUpperCase() + " " + realm.toUpperCase() + " Business Manager"
        },{
            "content": url,
            "description": "Go to " + instance.toUpperCase() + " " + realm.toUpperCase() + " Business Manager"
        }]
    }

    if (text.length > 2) {
        //console.log("[" + new Date() + "] omnibox event: input text length = 2");
        var realm = getRealm(text);
        if (realm == null) {
            return null;
        }
        var instance = getInstance(text);
        if (instance == null) {
            return null;
        }

        var pageSuggestions = getPageSuggestions(text);
        console.log("pageSuggestions: " + JSON.stringify(pageSuggestions));
        if (pageSuggestions == null) {
            return null;
        }
        
        suggestion = [];        
        for (var key in pageSuggestions) {            
            suggestion.push({                    
                "content": "https://" + instance + "-" + realm + "-loreal.demandware.net/on/demandware.store/Sites-Site/default/" + pageSuggestions[key],
                "description": realm.toUpperCase() + " > " + instance.toUpperCase() + " > " + key
            });
        }

        //console.log("suggestion: " + JSON.stringify(suggestion));
    }

    return suggestion;
}

function getRealm(text) {
    var realm = null;
    if (text.length < 1) {
        return null;
    }
    var firstCharacter = text.substr(0, 1);
    switch (firstCharacter) {
        case 'a':
            realm = "apac";
            break;
        
        case 'j':
            realm = "jp";
            break;                
        
        case 'c':
            realm = "cn";
            break;

        default:
            return null;
    }
    return realm;
}

function getInstance(text) {
    var instance = null;
    if (text.length < 2) {
        return null;
    }
    var secondCharacter = text.substr(1, 1);
    switch (secondCharacter) {
        case 'p':
            instance = "production";
            break;
        
        case 's':
            instance = "staging";
            break;                
        
        case 'd':
            instance = "development";
            break;

        default:
            return null;
    }
    return instance;
}

function getPageSuggestions(text) {
    var pageSuggestions = null;
    if (text.length < 3) {
        return null;
    }
    var charactersFromThird = text.substr(2).toLowerCase();
    pageSuggestions = [];
    for (var key in pageMapping) {
        if (key.toLowerCase().indexOf(charactersFromThird) > -1) {
            pageSuggestions[key] = pageMapping[key];
        }
    }
    if (Object.keys(pageSuggestions).length == 0) {
        return null;
    }
    return pageSuggestions;
}

/*
// 当用户按下tab chrome将输入交给插件，然后输入第一个字符之后触发此事件
chrome.omnibox.onInputStarted.addListener(() => {
    console.log("[" + new Date() + "] omnibox event: onInputStarted");
});

// 当用户的输入改变之后
// text 用户的当前输入
// suggest 调用suggest为用户提供搜索建议
chrome.omnibox.onInputChanged.addListener((text, suggest) => {
    console.log("[" + new Date() + "] omnibox event: onInputChanged, user input: " + text);
    // 为用户提供一些搜索建议
    suggest([{
        "content": text + " foo",
        "description": "是否要查看“" + text + " foo” 有关的内容？"
    }, {
        "content": text + " bar",
        "description": "是否要查看“" + text + " bar” 有关的内容？"
    }
    ]);
});

// 按下回车时事件，表示向插件提交了一个搜索
chrome.omnibox.onInputEntered.addListener((text, disposition) => {
    console.log("[" + new Date() + "] omnibox event: onInputEntered, user input: " + text + ", disposition: " + disposition);
});

// 取消输入时触发的事件，注意使用上下方向键在搜索建议列表中搜搜也会触发此事件
chrome.omnibox.onInputCancelled.addListener(() => {
    console.log("[" + new Date() + "] omnibox event: onInputCancelled");
});

// 当删除了搜索建议时触发的
chrome.omnibox.onDeleteSuggestion.addListener(text => {
    console.log("[" + new Date() + "] omnibox event: onDeleteSuggestion, text: " + text);
});

// 设置默认的搜索建议，会显示在搜索建议列表的第一行位置，content省略使用用户当前输入的text作为content
chrome.omnibox.setDefaultSuggestion({
    "description": "啥也不干，就是随便试试...."
})
*/